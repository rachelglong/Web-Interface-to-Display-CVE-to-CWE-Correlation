const express = require('express');
const mongoose = require('mongoose');
const morgan = require('morgan');

const PORT = 8080;
async function getClusterData() {
    try {

        mongoose.connect('mongodb://CPTS423:test@127.0.0.1/mydatabase');

        mongoose.connection.on('connected', () => {
            console.log('Mongoose is connected');
        });

        const schema = new mongoose.Schema({
            "clusterNum": Number,
            "highest_CWE": String,
            "highest_count": Number,
            "second_highest_CWE": String,
            "second_highest_count": Number,
            "top_two_percentage": Number
        });

        const model = mongoose.model('Test', schema);

        await model.init();
        const data = await model.find();

        const app = express();
        app.use(morgan('tiny'));

        app.get('/api', (req, res) => {
            res.json(data);
        });

        app.listen(PORT, console.log(`server is starting at ${PORT}`));

    } catch (error) {
        console.error(error);
    } finally {
        mongoose.connection.close();
    }
}

// for testing
async function main() {
    const data = await getClusterData();
}

main();
